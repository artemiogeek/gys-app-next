# ðŸ“… ImplementaciÃ³n de Fechas de Seguimiento - ListaEquipo

## ðŸŽ¯ Objetivo
Agregar campos de fecha de seguimiento al modelo `ListaEquipo` para mejorar el tracking del flujo de trabajo y la integraciÃ³n con el sistema de aprovisionamiento financiero.

## ðŸ“‹ Campos de Fecha Propuestos

### Nuevos Campos en `ListaEquipo`
```prisma
fechaNecesaria          DateTime?  // Fecha lÃ­mite para completar la lista
fechaEnvioRevision      DateTime?  // TransiciÃ³n: borrador â†’ por_validar
fechaValidacion         DateTime?  // TransiciÃ³n: por_validar â†’ por_aprobar
fechaAprobacionRevision DateTime?  // TransiciÃ³n: por_aprobar â†’ aprobada
fechaEnvioLogistica     DateTime?  // TransiciÃ³n: aprobada â†’ enviada_logistica
fechaInicioCotizacion   DateTime?  // Inicio del proceso de cotizaciÃ³n
fechaFinCotizacion      DateTime?  // Fin del proceso de cotizaciÃ³n
fechaAprobacionFinal    DateTime?  // AprobaciÃ³n final para pedidos
```

### Mapeo Estado â†’ Fecha
- `borrador` â†’ `fechaEnvioRevision` (al cambiar estado)
- `por_validar` â†’ `fechaValidacion` (al cambiar estado)
- `por_aprobar` â†’ `fechaAprobacionRevision` (al cambiar estado)
- `aprobada` â†’ `fechaEnvioLogistica` (al cambiar estado)
- `enviada_logistica` â†’ tracking en logÃ­stica

---

## ðŸš€ Plan de ImplementaciÃ³n

### Paso 1: MigraciÃ³n de Base de Datos

#### 1.1 Actualizar Schema Prisma
**Archivo:** `prisma/schema.prisma`

```prisma
model ListaEquipo {
  // ... campos existentes ...
  
  // âœ… Nuevos campos de fecha
  fechaNecesaria          DateTime?
  fechaEnvioRevision      DateTime?
  fechaValidacion         DateTime?
  fechaAprobacionRevision DateTime?
  fechaEnvioLogistica     DateTime?
  fechaInicioCotizacion   DateTime?
  fechaFinCotizacion      DateTime?
  fechaAprobacionFinal    DateTime?
  
  // ... resto del modelo ...
}
```

#### 1.2 Generar y Ejecutar MigraciÃ³n
```bash
npx prisma migrate dev --name add_fecha_seguimiento_lista_equipo
npx prisma generate
```

### Paso 2: Actualizar Tipos TypeScript

#### 2.1 Modelos Base
**Archivo:** `src/types/modelos.ts`

```typescript
export interface ListaEquipo {
  // ... campos existentes ...
  
  // âœ… Nuevos campos de fecha
  fechaNecesaria?: Date;
  fechaEnvioRevision?: Date;
  fechaValidacion?: Date;
  fechaAprobacionRevision?: Date;
  fechaEnvioLogistica?: Date;
  fechaInicioCotizacion?: Date;
  fechaFinCotizacion?: Date;
  fechaAprobacionFinal?: Date;
}
```

#### 2.2 Payloads de API
**Archivo:** `src/types/payloads.ts`

```typescript
export interface ListaEquipoCreatePayload {
  // ... campos existentes ...
  fechaNecesaria?: string; // ISO string
}

export interface ListaEquipoUpdatePayload {
  // ... campos existentes ...
  fechaNecesaria?: string;
  // Las demÃ¡s fechas se actualizan automÃ¡ticamente por el backend
}
```

### Paso 3: Modificar APIs

#### 3.1 API Route Principal
**Archivo:** `src/app/api/listas-equipo/route.ts`

```typescript
// âœ… En funciÃ³n POST (crear)
if (payload.fechaNecesaria) {
  data.fechaNecesaria = new Date(payload.fechaNecesaria);
}

// âœ… En funciÃ³n PUT (actualizar)
if (payload.fechaNecesaria !== undefined) {
  data.fechaNecesaria = payload.fechaNecesaria ? new Date(payload.fechaNecesaria) : null;
}
```

#### 3.2 API Route Individual
**Archivo:** `src/app/api/listas-equipo/[id]/route.ts`

```typescript
// âœ… Agregar lÃ³gica de fechas automÃ¡ticas en cambios de estado
if (payload.estado && payload.estado !== listaActual.estado) {
  const now = new Date();
  
  switch (payload.estado) {
    case 'por_validar':
      data.fechaEnvioRevision = now;
      break;
    case 'por_aprobar':
      data.fechaValidacion = now;
      break;
    case 'aprobada':
      data.fechaAprobacionRevision = now;
      break;
    case 'enviada_logistica':
      data.fechaEnvioLogistica = now;
      break;
  }
}
```

### Paso 4: Actualizar Servicios

#### 4.1 Servicio ListaEquipo
**Archivo:** `src/lib/services/listaEquipo.ts`

```typescript
// âœ… Actualizar interfaces
export interface ListaEquipoMaster extends ListaEquipo {
  // ... campos existentes ...
  
  // Agregar campos de fecha en las consultas
}

// âœ… Actualizar funciÃ³n de creaciÃ³n
export async function createListaEquipo(payload: ListaEquipoCreatePayload) {
  const response = await fetch('/api/listas-equipo', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      ...payload,
      fechaNecesaria: payload.fechaNecesaria
    })
  });
  // ...
}
```

### Paso 5: Actualizar Componentes UI

#### 5.1 Formulario de Lista
**Archivo:** `src/components/equipos/ListaEquipoForm.tsx`

```typescript
// âœ… Agregar campo fechaNecesaria
<div className="grid grid-cols-1 md:grid-cols-2 gap-4">
  {/* ... campos existentes ... */}
  
  <div className="space-y-2">
    <Label htmlFor="fechaNecesaria">Fecha Necesaria</Label>
    <Input
      id="fechaNecesaria"
      type="date"
      {...register('fechaNecesaria')}
    />
    {errors.fechaNecesaria && (
      <p className="text-sm text-red-500">{errors.fechaNecesaria.message}</p>
    )}
  </div>
</div>
```

#### 5.2 Componente Timeline de Fechas
**Archivo:** `src/components/equipos/ListaEquipoTimeline.tsx`

```typescript
'use client';

import { ListaEquipo } from '@/types/modelos';
import { formatDate } from '@/lib/utils';
import { CheckCircle, Clock, AlertCircle } from 'lucide-react';

interface Props {
  lista: ListaEquipo;
}

export function ListaEquipoTimeline({ lista }: Props) {
  const timelineEvents = [
    {
      label: 'CreaciÃ³n',
      date: lista.createdAt,
      status: 'completed',
      icon: CheckCircle
    },
    {
      label: 'EnvÃ­o a RevisiÃ³n',
      date: lista.fechaEnvioRevision,
      status: lista.fechaEnvioRevision ? 'completed' : 'pending',
      icon: lista.fechaEnvioRevision ? CheckCircle : Clock
    },
    {
      label: 'ValidaciÃ³n',
      date: lista.fechaValidacion,
      status: lista.fechaValidacion ? 'completed' : 'pending',
      icon: lista.fechaValidacion ? CheckCircle : Clock
    },
    {
      label: 'AprobaciÃ³n',
      date: lista.fechaAprobacionRevision,
      status: lista.fechaAprobacionRevision ? 'completed' : 'pending',
      icon: lista.fechaAprobacionRevision ? CheckCircle : Clock
    },
    {
      label: 'EnvÃ­o a LogÃ­stica',
      date: lista.fechaEnvioLogistica,
      status: lista.fechaEnvioLogistica ? 'completed' : 'pending',
      icon: lista.fechaEnvioLogistica ? CheckCircle : Clock
    }
  ];

  return (
    <div className="space-y-4">
      <h3 className="text-lg font-semibold">Timeline de Seguimiento</h3>
      <div className="space-y-3">
        {timelineEvents.map((event, index) => {
          const Icon = event.icon;
          return (
            <div key={index} className="flex items-center space-x-3">
              <Icon 
                className={`h-5 w-5 ${
                  event.status === 'completed' 
                    ? 'text-green-500' 
                    : 'text-gray-400'
                }`} 
              />
              <div className="flex-1">
                <p className="font-medium">{event.label}</p>
                <p className="text-sm text-gray-500">
                  {event.date ? formatDate(event.date) : 'Pendiente'}
                </p>
              </div>
            </div>
          );
        })}
      </div>
    </div>
  );
}
```

#### 5.3 Actualizar Vista Detalle
**Archivo:** `src/components/proyectos/ListaEquipoDetailView.tsx`

```typescript
// âœ… Agregar timeline en la vista detalle
import { ListaEquipoTimeline } from '@/components/equipos/ListaEquipoTimeline';

// En el componente:
<div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
  <div className="lg:col-span-2">
    {/* ... contenido existente ... */}
  </div>
  
  <div className="space-y-6">
    {/* ... sidebar existente ... */}
    
    <Card>
      <CardContent className="p-6">
        <ListaEquipoTimeline lista={lista} />
      </CardContent>
    </Card>
  </div>
</div>
```

### Paso 6: IntegraciÃ³n con Aprovisionamiento

#### 6.1 Actualizar MÃ©tricas Financieras
**Archivo:** `src/lib/services/aprovisionamientos.ts`

```typescript
// âœ… Incluir fechas en cÃ¡lculos de mÃ©tricas
export async function calcularMetricasAprovisionamiento(filtros: FiltrosAprovisionamientos) {
  // ... lÃ³gica existente ...
  
  // Agregar anÃ¡lisis de tiempos de proceso
  const tiemposPromedio = {
    validacion: calcularTiempoPromedio('fechaEnvioRevision', 'fechaValidacion'),
    aprobacion: calcularTiempoPromedio('fechaValidacion', 'fechaAprobacionRevision'),
    envioLogistica: calcularTiempoPromedio('fechaAprobacionRevision', 'fechaEnvioLogistica')
  };
  
  return {
    // ... mÃ©tricas existentes ...
    tiemposPromedio
  };
}
```

### Paso 7: ValidaciÃ³n con Zod

#### 7.1 Esquemas de ValidaciÃ³n
**Archivo:** `src/lib/validators/listaEquipo.ts`

```typescript
import { z } from 'zod';

export const listaEquipoCreateSchema = z.object({
  // ... campos existentes ...
  fechaNecesaria: z.string().datetime().optional()
    .refine((date) => {
      if (!date) return true;
      return new Date(date) > new Date();
    }, {
      message: 'La fecha necesaria debe ser futura'
    })
});

export const listaEquipoUpdateSchema = z.object({
  // ... campos existentes ...
  fechaNecesaria: z.string().datetime().optional().nullable()
});
```

### Paso 8: Testing

#### 8.1 Tests de API
**Archivo:** `src/__tests__/api/listas-equipo-fechas.test.ts`

```typescript
describe('/api/listas-equipo - Fechas de Seguimiento', () => {
  test('debe crear lista con fechaNecesaria', async () => {
    const payload = {
      nombre: 'Lista Test',
      fechaNecesaria: '2024-12-31T23:59:59.000Z'
    };
    
    const response = await request(app)
      .post('/api/listas-equipo')
      .send(payload)
      .expect(201);
    
    expect(response.body.fechaNecesaria).toBe(payload.fechaNecesaria);
  });
  
  test('debe actualizar fechas automÃ¡ticamente en cambios de estado', async () => {
    // ... test de cambios de estado ...
  });
});
```

#### 8.2 Tests de Componentes
**Archivo:** `src/__tests__/components/equipos/ListaEquipoTimeline.test.tsx`

```typescript
describe('ListaEquipoTimeline', () => {
  test('debe mostrar timeline correctamente', () => {
    const lista = {
      id: '1',
      createdAt: new Date('2024-01-01'),
      fechaEnvioRevision: new Date('2024-01-02'),
      fechaValidacion: new Date('2024-01-03'),
      // ...
    };
    
    render(<ListaEquipoTimeline lista={lista} />);
    
    expect(screen.getByText('Timeline de Seguimiento')).toBeInTheDocument();
    expect(screen.getByText('CreaciÃ³n')).toBeInTheDocument();
  });
});
```

---

## ðŸ”„ Orden de EjecuciÃ³n

### Fase 1: Base de Datos y Tipos
```bash
# 1. Actualizar schema Prisma
# 2. Generar migraciÃ³n
npx prisma migrate dev --name add_fecha_seguimiento_lista_equipo
npx prisma generate

# 3. Actualizar tipos TypeScript
# 4. Ejecutar tests de tipos
npm run type-check
```

### Fase 2: Backend (APIs y Servicios)
```bash
# 5. Actualizar API routes
# 6. Actualizar servicios
# 7. Actualizar validadores
# 8. Ejecutar tests de API
npm run test:api
```

### Fase 3: Frontend (Componentes y UI)
```bash
# 9. Actualizar formularios
# 10. Crear componente Timeline
# 11. Actualizar vistas detalle
# 12. Ejecutar tests de componentes
npm run test:components
```

### Fase 4: IntegraciÃ³n y Testing Final
```bash
# 13. Integrar con aprovisionamiento
# 14. Tests de integraciÃ³n
npm run test:integration

# 15. Tests completos
npm run test

# 16. Build y verificaciÃ³n
npm run build
```

---

## ðŸ“Š Beneficios Esperados

### Para el Flujo de Trabajo
- âœ… **Tracking completo** del ciclo de vida de listas
- âœ… **IdentificaciÃ³n de cuellos de botella** en el proceso
- âœ… **MÃ©tricas de tiempo** por etapa del flujo
- âœ… **Alertas automÃ¡ticas** por fechas vencidas

### Para Aprovisionamiento Financiero
- âœ… **Proyecciones mÃ¡s precisas** basadas en fechas reales
- âœ… **AnÃ¡lisis de tendencias** de tiempo de proceso
- âœ… **OptimizaciÃ³n de recursos** segÃºn patrones histÃ³ricos
- âœ… **Reportes ejecutivos** con mÃ©tricas de eficiencia

### Para UX/UI
- âœ… **Timeline visual** del progreso de listas
- âœ… **Indicadores de estado** mÃ¡s informativos
- âœ… **Dashboards mejorados** con datos temporales
- âœ… **Experiencia de usuario** mÃ¡s transparente

---

## ðŸš¨ Consideraciones Importantes

### MigraciÃ³n de Datos Existentes
- Los campos nuevos serÃ¡n `NULL` para registros existentes
- Considerar script de migraciÃ³n para poblar fechas histÃ³ricas si es necesario

### Performance
- Indexar campos de fecha mÃ¡s consultados
- Optimizar queries que filtren por rangos de fechas

### Compatibilidad
- Mantener retrocompatibilidad en APIs
- Validar que componentes existentes no se rompan

### Testing
- Probar todos los flujos de cambio de estado
- Validar cÃ¡lculos de mÃ©tricas con datos reales
- Tests de performance con volÃºmenes grandes

---

**Documento creado siguiendo el FLUJO_GYS y estÃ¡ndares enterprise del proyecto.**